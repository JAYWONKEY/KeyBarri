# 프롬프트 수정 

'''
질문을 입력하세요 (종료: q):  디카페인 메가리카노 2개랑 바닐라라떼 아이스, 코코넛 커피 스무디 3개 주세요

답변 생성 중...

질문: 디메가리카노 2개랑 바닐라라떼 아이스, 코코넛 커피 스무디 3개 주세요
답변: 주문하신 메뉴는 없는 메뉴이거나, 현재 제공하지 않는 메뉴입니다. 메뉴에 있는 상품으로 다시 주문해주세요.
**주문 가능한 메뉴:**

*   **디저트:** 메가쿠키(마카다미아) (2000원)
*   **커피(콜드브루):** 콜드브루오리지널 (3500원)
*   **디카페인:** 디카페인 바닐라아메리카노 (3700원)
*   **커피(HOT):** 바닐라아메리카노 (2700원)

**참고:**

*   "디메가리카노"는 메뉴에 없습니다.
*   "바닐라라떼 아이스"는 메뉴에 없습니다.
*   "코코넛 커피 스무디"는 메뉴에 없습니다.

TTS 변환 중...


'''

- ** 등 읽을 필요 없는 부분 삭제 필요
- 해당 출력물 + ui 같이 나오게끔 하는건 어떤가요


- Trouble Shooting1
    - 1.TTS 출력 개선
        - LLM 응답 그대로 TTS 변환 → 마크다운 기호와 포맷팅이 모두 읽힌다
        '''
        def claen_text_for_tts(text):
            """TTS를 위한 텍스트 정제 함수"""
            # 마크다운 굵은 글씨 표시 제거
            text = re.sub(r'\*\*(.*?)\*\*', r'\1', text)
            # 마크다운 이탤릭체 표시 제거
            text = re.sub(r'\*(.*?)\*', r'\1', text)
            # 불필요한 기호 및 텍스트 제거
            text = re.sub(r'참고:', '참고 사항으로', text)
            text = re.sub(r'[\[\]\(\)\{\}]', '', text)
            # 여러 줄바꿈을 하나로 통일
            text = re.sub(r'\n+', '\n', text)
            # 줄바꿈을 자연스러운 문장 구분으로 변환
            text = re.sub(r'\n', '. ', text)
            # 불필요한 공백 제거
            text = re.sub(r'\s+', ' ', text)
            return text.strip()
        '''
    - 2. main.py 내 def load_csv_data(csv_path) 메소드 내 코드
        '''
        기존 코드
        texts = df.apply(lambda x: ' '.join(x.astype(str)), axis=1).tolist()
        모든 열을 그냥 몽땅 이어붙이는 방식 
        (필요 없는 것도 다 붙음... 예: 인덱스 번호, HOT/ICE 정보, 이미지 경로 등)

        수정 코드
        # 25.04.29 기능 추가 : 첫 번째 컬럼이 번호면 제거
        if df.columns[0].lower() in ['no', 'index', 'id', '번호', 'id'] or df.iloc[:,0].astype(str).str.match(r'^\d+$').all():
            print("번호 컬럼 제거")
            df = df.iloc[:, 1:]

        '''

    - 3. 정규식 수정
        '''
        text = re.sub(r'\(.*?\)', '', text) # (안의내용) 제거
        text = re.sub(r'\[.*?\]', '', text) # [안의내용] 제거

        .*? non-greedy 방식으로 최소 범위만 매칭한다.

        text = "가격은 (예: 3000원)으로 구성됩니다."
        text = re.sub(r'\(.*?\)', '', text)
        print(text)  # => "가격은 으로 구성됩니다."

        df.iloc[:,0].astype(str).str.match(r'^\d+$').all()
        인덱스 전체에서 0번 컬럼을 가져와 문자열로 변환(astype), 변환된것을 정규식 적용한다.
        ^ : 문자열 시작
        \d+: 숫자가 하나 이상(+는 1개 이상을 뜻함)
        $ : 문자열의 끝
    
        '''
    - 4. data.csv 내 인덱스 제거
        '''
        - load_csv_data(csv_path)
        - 데이터에서 이름, 가격, 설명 부분만 추출하고 싶음
        1. csv 파일을 읽는다
        2. csv 파일 내 첫번째 열인 인덱스를 지운다
            
            df = df.iloc[:, 1:]
            
        3. 필요한 컬럼만 뽑아 문장 만든다
        
        4. 나온 문장을 `claen_text_for_tts(text)`에 넣어서 깨끗이 다듬는다
        '''

- Trouble Shooting 2
    - 허브티 → 키오스크에서 길게 얘기 안해도 괜찮으니
       TTS 답변이 온다면 총 ‘가격, ‘이름’ 만 설정해라
    '''
        질문을 입력하세요 (종료: q): 스무디 먹고 싶은데 추천해ㅜ저

        답변 생성 중...

        질문: 스무디 먹고 싶은데 추천해ㅜ저
        답변: 상큼한 딸기 바나나 스무디 어때? 새콤달콤해서 딱 좋을 것 같아! 아니면 쿠키나 샌드위치도 괜
        찮아.


        TTS 변환 중...

        [TTS용 정제된 텍스트]
        상큼한 딸기 바나나 스무디 어때? 새콤달콤해서 딱 좋을 것 같아! 아니면 쿠키나 샌드위치도 괜찮아..
        질문을 입력하세요 (종료: q): 딸기 바나나 스무디 말고 다른 스무디 없어?

        답변 생성 중...

        질문: 딸기 바나나 스무디 말고 다른 스무디 없어?
        답변: 딸기 바나나 스무디 외에는 다른 스무디는 아직 없어요. 대신 허브티나 녹차는 어떠세요? 둘 다
        인기 많아요.


        TTS 변환 중...

        [TTS용 정제된 텍스트]
        딸기 바나나 스무디 외에는 다른 스무디는 아직 없어요. 대신 허브티나 녹차는 어떠세요? 둘 다 인기 
        많아요..

        질문을 입력하세요 (종료: q): 무슨 허브티?

        답변 생성 중...

        질문: 무슨 허브티?
        답변: 마음을 진정시켜주는 산뜻한 풀내음을 느낄 수 있는 허브티가 있어요.

        TTS 변환 중...

        [TTS용 정제된 텍스트]
        마음을 진정시켜주는 산뜻한 풀내음을 느낄 수 있는 허브티가 있어요.

        질문을 입력하세요 (종료: q): 허브티 중에서 추천해주

        답변 생성 중...

        질문: 허브티 중에서 추천해주
        답변: 허브티는 마음을 진정시켜주는 산뜻한 풀내음을 느낄 수 있어요. 드셔보시는 거 어때요?       


        TTS 변환 중...

        [TTS용 정제된 텍스트]
        허브티는 마음을 진정시켜주는 산뜻한 풀내음을 느낄 수 있어요. 드셔보시는 거 어때요?.

        질문을 입력하세요 (종료: q): 아니 허브티 메뉴 중에 추천할거 없어?

        답변 생성 중...

        질문: 아니 허브티 메뉴 중에 추천할거 없어?
        답변: 네, 허브티는 마음을 진정시켜주는 산뜻한 풀내음을 느낄 수 있는 메뉴가 있어요.


        TTS 변환 중...

        [TTS용 정제된 텍스트]
        네, 허브티는 마음을 진정시켜주는 산뜻한 풀내음을 느낄 수 있는 메뉴가 있어요..

        질문을 입력하세요 (종료: q):
    '''
    - 맥락 기능
        대화의 흐름을 연결하고 있지만 현재 시스템은 질문 단발 처리 → 앞 맥락을 반영 못하고 있다
         1. CSV 내 더많은 정보 포함 필요 
        2. 프롬프트 더 구체화
        3. 메뉴 DataFrame 코드 추가 필요
        1. 특화된 메뉴 추가
            1. 성별
            2. 나이 → deepface (모델)
            3. 4대 질병 나이 구간 설정
            '''
            나이대 구간 설정
            나이대    설명
            0~12세 (어린이)    성장기, 칼슘/단백질/비타민 D
            13~18세 (청소년)    급성장, 철분/단백질/칼슘/비타민
            19~29세 (청년)    에너지 대사, 비타민B군/단백질/철분
            30~49세 (중년)    건강 유지, 항산화물질(비타민C, E), 식이섬유
            50~64세 (장년)    심혈관, 칼슘/비타민 D/오메가3
            65세 이상 (노년)    근력, 단백질/비타민 D/칼슘/오메가3

            - 영양성분 및 연령 별 커피 추천 설계
            | 질환명 | 피해야 할 영양소 |
            | --- | --- |
            | 당뇨병 | **당류** |
            | 고혈압 | **나트륨** |
            | 심장질환 | **지방, 카페인** |
            | 고지혈증 | **포화지방, 총지방** |

            ## ✅ 포용법 적용 UX 요소

            | 항목 | 설명 |
            | --- | --- |
            | **글자 크기/색상 대비** | 고령층·저시력자 위해 18pt 이상, 명확한 배경 대비 |
            | **음성 안내** | 청각 정보 보조, 모든 텍스트에 음성지원 버튼 |
            | **터치 인터페이스** | 시니어/지체장애인 위한 대형 버튼 UI |
            | **쉬운 추천 프로세스** | "간단한 추천 받기" 버튼으로 최소 단계로 커피 추천 |
            '''


- Trouble Shooting3

    - 1. 프롬프트 내 메뉴명 생성을 유도하지 못했다.
    - 2. 인기 있는 메뉴 → csv내 인기도정보가 없어서 반복문 내 같은     
         답만 계속 나온다.
        '''
            def rag_pipeline(query: str, context_chunks: list, embedder, index, top_k: int = 4, menu_df=None) -> str:
            """RAG 파이프라인 실행"""
            query_embed = embedder.encode([query])
            distances, indices = index.search(query_embed, min(top_k, len(context_chunks)))
            context = [context_chunks[i] for i in indices[0]]
            
            model = genai.GenerativeModel('gemini-2.0-flash')
            prompt = f"""다음 데이터를 바탕으로 질문에 답변해주세요.

            데이터:
            {' '.join(context)}

            질문: {query}
                답변은 사람이 직접 대화하는 것처럼 자연스럽고 간결하게 해주세요.
                특수문자나 마크다운 포맷은 사용하지 말고, 음성으로 변환되었을 때 자연스럽게 들리도록 해주세요.
                메뉴 추천을 할 때는 가장 인기 있는 2-3개 항목만 간결하게 언급해주세요.

            답변:"""
                
                response = model.generate_content(prompt)
                # 25.04.29 응답 전처리 및 포맷팅
                preprocess_response =  preprocess_rag_response(response.text, menu_df)
                return preprocess_response
                # return response.text

        '''

        
 

